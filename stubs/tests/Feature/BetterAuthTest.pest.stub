<?php

declare(strict_types=1);

use Illuminate\Foundation\Testing\RefreshDatabase;
use function Pest\Laravel\{json, postJson, getJson, putJson};

uses(RefreshDatabase::class);

/**
 * BetterAuth Authentication Test (Pest).
 *
 * Generated by BetterAuth. Run with: php artisan test --filter=BetterAuthTest
 */

$email = 'test@example.com';
$password = 'SecurePassword123!';
$name = 'Test User';

/**
 * Test user can register.
 */
test('user can register', function () use ($email, $password, $name) {
    $response = postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $response->assertStatus(201)
        ->assertJsonStructure([
            'message',
            'user' => [
                'id',
                'email',
                'name',
            ],
            'access_token',
            'refresh_token',
            'token_type',
            'expires_in',
        ]);

    $this->assertDatabaseHas('users', [
        'email' => $email,
    ]);
});

/**
 * Test user cannot register with invalid email.
 */
test('user cannot register with invalid email', function () use ($password, $name) {
    $response = postJson('/auth/register', [
        'email' => 'not-an-email',
        'password' => $password,
        'name' => $name,
    ]);

    $response->assertStatus(422)
        ->assertJsonValidationErrors(['email']);
});

/**
 * Test user cannot register with weak password.
 */
test('user cannot register with weak password', function () use ($email, $name) {
    $response = postJson('/auth/register', [
        'email' => $email,
        'password' => 'short',
        'name' => $name,
    ]);

    $response->assertStatus(422)
        ->assertJsonValidationErrors(['password']);
});

/**
 * Test user can login with valid credentials.
 */
test('user can login with valid credentials', function () use ($email, $password, $name) {
    // First register a user
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    // Then login
    $response = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $response->assertStatus(200)
        ->assertJsonStructure([
            'message',
            'user',
            'access_token',
            'refresh_token',
            'token_type',
            'expires_in',
        ]);
});

/**
 * Test user cannot login with invalid credentials.
 */
test('user cannot login with invalid credentials', function () use ($email) {
    $response = postJson('/auth/login', [
        'email' => $email,
        'password' => 'wrong-password',
    ]);

    $response->assertStatus(422)
        ->assertJsonValidationErrors(['email']);
});

/**
 * Test authenticated user can access protected route.
 */
test('authenticated user can access protected route', function () use ($email, $password, $name) {
    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $token = $loginResponse->json('access_token');

    // Access protected route
    $response = getJson('/auth/me', [
        'Authorization' => 'Bearer ' . $token,
    ]);

    $response->assertStatus(200)
        ->assertJson([
            'user' => [
                'email' => $email,
            ],
        ]);
});

/**
 * Test unauthenticated user cannot access protected route.
 */
test('unauthenticated user cannot access protected route', function () {
    $response = getJson('/auth/me');

    $response->assertStatus(401);
});

/**
 * Test user can refresh access token.
 */
test('user can refresh access token', function () use ($email, $password, $name) {
    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $refreshToken = $loginResponse->json('refresh_token');

    // Refresh token
    $response = postJson('/auth/refresh', [
        'refresh_token' => $refreshToken,
    ]);

    $response->assertStatus(200)
        ->assertJsonStructure([
            'message',
            'access_token',
            'refresh_token',
            'token_type',
            'expires_in',
        ]);
});

/**
 * Test user cannot refresh with invalid token.
 */
test('user cannot refresh with invalid token', function () {
    $response = postJson('/auth/refresh', [
        'refresh_token' => 'invalid-token',
    ]);

    $response->assertStatus(401);
});

/**
 * Test user can logout.
 */
test('user can logout', function () use ($email, $password, $name) {
    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $refreshToken = $loginResponse->json('refresh_token');

    // Logout
    $response = postJson('/auth/logout', [
        'refresh_token' => $refreshToken,
    ]);

    $response->assertStatus(200)
        ->assertJson([
            'message' => 'Logged out successfully',
        ]);
});

/**
 * Test user can revoke all tokens.
 */
test('user can revoke all tokens', function () use ($email, $password, $name) {
    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $token = $loginResponse->json('access_token');

    // Revoke all tokens
    $response = putJson('/auth/revoke-all', [], [
        'Authorization' => 'Bearer ' . $token,
    ]);

    $response->assertStatus(200)
        ->assertJson([
            'message' => 'All tokens revoked',
        ]);
});

/**
 * Test user can update password.
 */
test('user can update password', function () use ($email, $password, $name) {
    $newPassword = 'NewSecurePassword456!';

    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $token = $loginResponse->json('access_token');

    // Update password
    $response = putJson('/auth/password', [
        'current_password' => $password,
        'password' => $newPassword,
        'password_confirmation' => $newPassword,
    ], [
        'Authorization' => 'Bearer ' . $token,
    ]);

    $response->assertStatus(200)
        ->assertJson([
            'message' => 'Password updated successfully',
        ]);

    // Verify login with new password works
    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $newPassword,
    ]);

    $loginResponse->assertStatus(200);
});

/**
 * Test user cannot update password with wrong current password.
 */
test('user cannot update password with wrong current password', function () use ($email, $password, $name) {
    $newPassword = 'NewSecurePassword456!';

    // Register and login
    postJson('/auth/register', [
        'email' => $email,
        'password' => $password,
        'name' => $name,
    ]);

    $loginResponse = postJson('/auth/login', [
        'email' => $email,
        'password' => $password,
    ]);

    $token = $loginResponse->json('access_token');

    // Try to update with wrong current password
    $response = putJson('/auth/password', [
        'current_password' => 'wrong-password',
        'password' => $newPassword,
        'password_confirmation' => $newPassword,
    ], [
        'Authorization' => 'Bearer ' . $token,
    ]);

    $response->assertStatus(422)
        ->assertJsonValidationErrors(['current_password']);
});
